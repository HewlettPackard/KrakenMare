#
# services:
#  zookeeper
#  kafka broker 1-3
#  mosquitto
#  simulator
#  druid
#  grafana
#  kafka connect
#  schema registry
#  framework
#  redis
#  collectd
#

# Docker compose version
version: '3.4'

# Deploy via swarm has this included in most services
x-deploy: &deploy
  deploy:
    restart_policy:
      condition: none
    placement:
      constraints:
        - node.labels.supervisory_cloud == true
# Cannot activate this for now due to the way we propagate ansible vars to docker labels
#      preferences:
#        - spread:  node.labels.supervisory_zone

services:
  zookeeper:
    image: ${REGISTRY_FULL_PATH}zookeeper
    hostname: zookeeper
    build:
      context: zookeeper
      dockerfile: Dockerfile
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/zookeeper/secrets/zookeeper_jaas.conf -Dzookeeper.authProvider.1=org.apache.zookeeper.server.auth.SASLAuthenticationProvider -DrequireClientAuthScheme=sasl"
    secrets:
      - source: zookeeper_jaas.conf
        target: /etc/zookeeper/secrets/zookeeper_jaas.conf
    networks:
      - zookeeper_kafka
    <<: *deploy

  broker-1:
    image: ${REGISTRY_FULL_PATH}kafka-broker
    build:
      context: kafka-broker
      dockerfile: Dockerfile
    hostname: broker-1
    ports:
      - "9092:9092"
      - "9982:9982"
      - "31757:31757"
      - "19092:19092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://broker-1:9092,SSL://broker-1:19092,SASL_SSL://broker-1:29092,SASL_SSL_HOST://localhost:39092'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_DELETE_TOPIC_ENABLE: 'true'
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_CUB_ZK_TIMEOUT: 240
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_SSL:SASL_SSL,SSL:SSL,SASL_SSL_HOST:SASL_SSL,PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_SSL
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.auth.SimpleAclAuthorizer
      KAFKA_SUPER_USERS: User:client;User:schemaregistry;User:broker;User:connect;User:ANONYMOUS
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-256
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-256
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.broker-1.keystore.pfx
      KAFKA_SSL_KEYSTORE_CREDENTIALS: broker-1_keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: broker-1_sslkey_creds
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.broker-1.truststore.pfx
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: broker-1_truststore_creds
      # enables 2-way authentication
      KAFKA_SSL_CLIENT_AUTH: "required"
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: "HTTPS"
      KAFKA_ZOOKEEPER_SET_ACL: "true"
      KAFKA_LOG4J_ROOT_LOGLEVEL: ERROR
      KAFKA_LOG4J_LOGGERS: "kafka.authorizer.logger=INFO,kafka=WARN,kafka.controller=WARN,kafka.request.logger=WARN,state.change.logger=WARN,kafka.producer.async.DefaultEventHandler=WARN,kafka.log.LogCleaner=WARN"
      KAFKA_HEAP_OPTS: '-Xms6g -Xmx6g -XX:MetaspaceSize=96m -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:G1HeapRegionSize=16M -XX:MinMetaspaceFreeRatio=50 -XX:MaxMetaspaceFreeRatio=80'
      # KAFKA_JMX_OPTS: "-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.host=broker-1 -Dcom.sun.management.jmxremote.port=9992 -Djava.rmi.server.hostname=broker-1 -Dcom.sun.management.jmxremote.rmi.port=9992 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/secrets/broker_jaas.conf -javaagent:/opt/prometheus/jmx_prometheus_javaagent-0.12.0.jar=9982:/opt/prometheus/kafka-2_0_0.yml"
    secrets:
      - source: broker_jaas.conf
        target: /etc/kafka/secrets/broker_jaas.conf
      - source: kafka.broker-1.keystore.pfx
        target: /etc/kafka/secrets/kafka.broker-1.keystore.pfx
      - source: broker-1_keystore_creds
        target: /etc/kafka/secrets/broker-1_keystore_creds
      - source: broker-1_sslkey_creds
        target: /etc/kafka/secrets/broker-1_sslkey_creds
      - source: kafka.broker-1.truststore.pfx
        target: /etc/kafka/secrets/kafka.broker-1.truststore.pfx
      - source: broker-1_truststore_creds
        target: /etc/kafka/secrets/broker-1_truststore_creds
    deploy:
      restart_policy:
        condition: none
      placement:
        constraints:
          - node.labels.broker-1 == true
    networks:
      - zookeeper_kafka
      - krakenmare

  broker-2:
    image: ${REGISTRY_FULL_PATH}kafka-broker
    build:
      context: kafka-broker
      dockerfile: Dockerfile
    hostname: broker-2
    ports:
      - "9093:9093"
      - "9983:9983"
      - "31758:31757"
      - "19093:19093"
      - "29093:29093"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://broker-2:9093,SSL://broker-2:19093,SASL_SSL://broker-2:29093,SASL_SSL_HOST://localhost:39093'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_DELETE_TOPIC_ENABLE: 'true'
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_CUB_ZK_TIMEOUT: 240
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_SSL:SASL_SSL,SSL:SSL,SASL_SSL_HOST:SASL_SSL,PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_SSL
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.auth.SimpleAclAuthorizer
      KAFKA_SUPER_USERS: User:client;User:schemaregistry;User:broker;User:connect;User:ANONYMOUS
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-256
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-256
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.broker-2.keystore.pfx
      KAFKA_SSL_KEYSTORE_CREDENTIALS: broker-2_keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: broker-2_sslkey_creds
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.broker-2.truststore.pfx
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: broker-2_truststore_creds
      # enables 2-way authentication
      KAFKA_SSL_CLIENT_AUTH: "required"
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: "HTTPS"
      KAFKA_ZOOKEEPER_SET_ACL: "true"
      KAFKA_LOG4J_ROOT_LOGLEVEL: ERROR
      KAFKA_LOG4J_LOGGERS: "kafka.authorizer.logger=INFO,kafka=WARN,kafka.controller=WARN,kafka.request.logger=WARN,state.change.logger=WARN,kafka.producer.async.DefaultEventHandler=WARN,kafka.log.LogCleaner=WARN"
      KAFKA_HEAP_OPTS: '-Xms6g -Xmx6g -XX:MetaspaceSize=96m -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:G1HeapRegionSize=16M -XX:MinMetaspaceFreeRatio=50 -XX:MaxMetaspaceFreeRatio=80'
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/secrets/broker_jaas.conf -javaagent:/opt/prometheus/jmx_prometheus_javaagent-0.12.0.jar=9983:/opt/prometheus/kafka-2_0_0.yml"
    secrets:
      - source: broker_jaas.conf
        target: /etc/kafka/secrets/broker_jaas.conf
      - source: kafka.broker-2.keystore.pfx
        target: /etc/kafka/secrets/kafka.broker-2.keystore.pfx
      - source: broker-2_keystore_creds
        target: /etc/kafka/secrets/broker-2_keystore_creds
      - source: broker-2_sslkey_creds
        target: /etc/kafka/secrets/broker-2_sslkey_creds
      - source: kafka.broker-2.truststore.pfx
        target: /etc/kafka/secrets/kafka.broker-2.truststore.pfx
      - source: broker-2_truststore_creds
        target: /etc/kafka/secrets/broker-2_truststore_creds
    deploy:
      restart_policy:
        condition: none
      placement:
        constraints:
          - node.labels.broker-2 == true
    networks:
      - zookeeper_kafka
      - krakenmare

  broker-3:
    image: ${REGISTRY_FULL_PATH}kafka-broker
    build:
      context: kafka-broker
      dockerfile: Dockerfile
    hostname: broker-3
    ports:
      - "9094:9094"
      - "9984:9984"
      - "31759:31757"
      - "19094:19094"
      - "29094:29094"
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://broker-3:9094,SSL://broker-3:19094,SASL_SSL://broker-3:29094,SASL_SSL_HOST://localhost:39094'
      KAFKA_CUB_ZK_TIMEOUT: 240
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_DELETE_TOPIC_ENABLE: 'true'
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_CUB_ZK_TIMEOUT: 240
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_SSL:SASL_SSL,SSL:SSL,SASL_SSL_HOST:SASL_SSL,PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_SSL
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.auth.SimpleAclAuthorizer
      KAFKA_SUPER_USERS: User:client;User:schemaregistry;User:broker;User:connect;User:ANONYMOUS
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-256
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-256
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.broker-3.keystore.pfx
      KAFKA_SSL_KEYSTORE_CREDENTIALS: broker-3_keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: broker-3_sslkey_creds
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.broker-3.truststore.pfx
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: broker-3_truststore_creds
      # enables 2-way authentication
      KAFKA_SSL_CLIENT_AUTH: "required"
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: "HTTPS"
      KAFKA_ZOOKEEPER_SET_ACL: "true"
      KAFKA_LOG4J_ROOT_LOGLEVEL: ERROR
      KAFKA_LOG4J_LOGGERS: "kafka.authorizer.logger=INFO,kafka=WARN,kafka.controller=WARN,kafka.request.logger=WARN,state.change.logger=WARN,kafka.producer.async.DefaultEventHandler=WARN,kafka.log.LogCleaner=WARN"
      KAFKA_HEAP_OPTS: '-Xms6g -Xmx6g -XX:MetaspaceSize=96m -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:G1HeapRegionSize=16M -XX:MinMetaspaceFreeRatio=50 -XX:MaxMetaspaceFreeRatio=80'
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/secrets/broker_jaas.conf -javaagent:/opt/prometheus/jmx_prometheus_javaagent-0.12.0.jar=9984:/opt/prometheus/kafka-2_0_0.yml"
    secrets:
      - source: broker_jaas.conf
        target: /etc/kafka/secrets/broker_jaas.conf
      - source: kafka.broker-3.keystore.pfx
        target: /etc/kafka/secrets/kafka.broker-3.keystore.pfx
      - source: broker-3_keystore_creds
        target: /etc/kafka/secrets/broker-3_keystore_creds
      - source: broker-3_sslkey_creds
        target: /etc/kafka/secrets/broker-3_sslkey_creds
      - source: kafka.broker-3.truststore.pfx
        target: /etc/kafka/secrets/kafka.broker-3.truststore.pfx
      - source: broker-3_truststore_creds
        target: /etc/kafka/secrets/broker-3_truststore_creds
    deploy:
      restart_policy:
        condition: none
      placement:
        constraints:
          - node.labels.broker-3 == true
    networks:
      - zookeeper_kafka
      - krakenmare

  mosquitto:
    image: eclipse-mosquitto:latest
    hostname: mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    <<: *deploy
    networks:
      - krakenmare

  test-tools:
    image: ${REGISTRY_FULL_PATH}test-tools
    build:
      context: test-tools
      dockerfile: Dockerfile
    hostname: test
    environment:
      MOSQUITTO_IP: mosquitto
      KAFKA_BROKER_IP: broker-1
    <<: *deploy
    secrets:
      - zookeeper_jaas.conf
      - broker_jaas.conf
      - client-sasl_ssl.conf
      - kafka.broker-1.keystore.jks
      - broker-1_keystore_creds
      - broker-1_sslkey_creds
      - kafka.broker-1.truststore.pfx
      - broker-1_truststore_creds
      - kafka.broker-2.keystore.pfx
      - broker-2_keystore_creds
      - broker-2_sslkey_creds
      - kafka.broker-2.truststore.pfx
      - broker-2_truststore_creds
      - kafka.broker-3.keystore.pfx
      - broker-3_keystore_creds
      - broker-3_sslkey_creds
      - kafka.broker-3.truststore.pfx
      - broker-3_truststore_creds
      - kafka.schemaregistry.truststore.pfx
      - kafka.schemaregistry.keystore.pfx
      - kafka.connect.truststore.pfx
      - kafka.connect.keystore.pfx
      - kafka.client.truststore.pfx
      - kafka.client.keystore.pfx
      - connect.certificate.pem
      - broker-1.certificate.pem
      - broker-2.certificate.pem
      - broker-3.certificate.pem
      - client.certificate.pem
      - schemaregistry.certificate.pem
      - connect.key
      - broker-1.key
      - broker-2.key
      - broker-3.key
      - client.key
      - schemaregistry.key
      - km-ca-1.crt
      - km-ca-1.key
      - km-ca-1.srl
    networks:
      - zookeeper_kafka
      - krakenmare

  simulator:
    image: ${REGISTRY_FULL_PATH}simulator
    build:
      context: simulator
      dockerfile: Dockerfile
    hostname: simulator
    <<: *deploy
    networks:
      - krakenmare

  fanin:
    image: ${REGISTRY_FULL_PATH}fanin
    build:
      context: fanin
      dockerfile: Dockerfile
    hostname: fanin
    <<: *deploy
    networks:
      - krakenmare

  kafka-embedded-client-1:
    image: ${REGISTRY_FULL_PATH}kafka-embedded-client-1
    build:
      context: kafka-client
      dockerfile: Dockerfile
    hostname: kafka-emb1
    environment:
      KAFKA_BROKER_IP: broker-1
    <<: *deploy
    networks:
      - krakenmare

  mousttic-1:
    image: ${REGISTRY_FULL_PATH}mousttic-1
    build:
      context: mousttic
      dockerfile: Dockerfile
    hostname: mousttic-1
    environment:
      MOSQUITTO_IP: mosquitto
    <<: *deploy
    networks:
      - krakenmare

  druid:
    image: ${REGISTRY_FULL_PATH}druid
    build:
      context: druid
      dockerfile: Dockerfile
    hostname: druid
    ports:
# - 8081: HTTP (coordinator)
# - 8082: HTTP (broker)
# - 8083: HTTP (historical)
# - 8090: HTTP (overlord)
# - 3306: MySQL
      - "8181:8081"
      - "8182:8082"
      - "8183:8083"
      - "8190:8090"
      - "8200:8200"
      - "3306:3306"
      - "9095:9095"
      - "1527:1527"
    <<: *deploy
    networks:
      - zookeeper_kafka
      - krakenmare

  grafana:
    image: ${REGISTRY_FULL_PATH}grafana
    build:
      context: grafana
      dockerfile: Dockerfile
    hostname: grafana
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/provisioning/:/etc/grafana/provisioning
      - ./grafana/dashboards/:/etc/grafana/dashboards
    <<: *deploy
    networks:
      - krakenmare

  schemaregistry:
    image: ${REGISTRY_FULL_PATH}schemaregistry
    build:
      context: schemaregistry
      dockerfile: Dockerfile
    hostname: schemaregistry
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schemaregistry
      SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL: 'zookeeper:2181'
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: "SASL_SSL://broker-1:29092,SASL_SSL://broker-2:29093,SASL_SSL://broker-3:29094"
      SCHEMA_REGISTRY_HOST_NAME: schemaregistry
      SCHEMA_REGISTRY_LISTENERS: "https://0.0.0.0:8081"
      SCHEMA_REGISTRY_KAFKASTORE_SECURITY_PROTOCOL: SASL_SSL
      SCHEMA_REGISTRY_KAFKASTORE_SASL_JAAS_CONFIG: "org.apache.kafka.common.security.scram.ScramLoginModule required  username=\"schemaregistry\" password=\"schemaregistry-secret\";"
      SCHEMA_REGISTRY_KAFKASTORE_SASL_MECHANISM: SCRAM-SHA-256
      SCHEMA_REGISTRY_KAFKASTORE_SSL_TRUSTSTORE_LOCATION: /etc/schema-registry/secrets/kafka.schemaregistry.truststore.pfx
      SCHEMA_REGISTRY_KAFKASTORE_SSL_TRUSTSTORE_PASSWORD: krakenmare
      SCHEMA_REGISTRY_KAFKASTORE_SSL_KEYSTORE_LOCATION: /etc/schema-registry/secrets/kafka.schemaregistry.keystore.pfx
      SCHEMA_REGISTRY_KAFKASTORE_SSL_KEYSTORE_PASSWORD: krakenmare
      SCHEMA_REGISTRY_KAFKASTORE_SSL_KEY_PASSWORD: krakenmare
      SCHEMA_REGISTRY_KAFKASTORE_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: "HTTPS"
      SCHEMA_REGISTRY_SSL_TRUSTSTORE_LOCATION: /etc/schema-registry/secrets/kafka.schemaregistry.truststore.pfx
      SCHEMA_REGISTRY_SSL_TRUSTSTORE_PASSWORD: krakenmare
      SCHEMA_REGISTRY_SSL_KEYSTORE_LOCATION: /etc/schema-registry/secrets/kafka.schemaregistry.keystore.pfx
      SCHEMA_REGISTRY_SSL_KEYSTORE_PASSWORD: krakenmare
      SCHEMA_REGISTRY_SSL_KEY_PASSWORD: krakenmare
      # Disable SR client auth as temporary workaround to software bug
      SCHEMA_REGISTRY_SSL_CLIENT_AUTH: "false"
      SCHEMA_REGISTRY_SCHEMA_REGISTRY_INTER_INSTANCE_PROTOCOL: "https"
    secrets:
      - source: kafka.schemaregistry.truststore.pfx
        target: /etc/schema-registry/secrets/kafka.schemaregistry.truststore.pfx
      - source: kafka.schemaregistry.keystore.pfx
        target: /etc/schema-registry/secrets/kafka.schemaregistry.keystore.pfx
    <<: *deploy
    networks:
      - zookeeper_kafka
      - krakenmare

  connect:
    image: ${REGISTRY_FULL_PATH}connect
    build:
      context: kafka-connect
      dockerfile: Dockerfile
    hostname: connect
    ports:
      - "8083:8083"
    environment:
      CONNECT_BOOTSTRAP_SERVERS: 'broker-1:9092,broker-2:9093,broker-3:9094'
# for SASL_SSL      CONNECT_BOOTSTRAP_SERVERS: 'broker-1:29092,broker-2:29093,broker-3:29094'
      CONNECT_REST_ADVERTISED_HOST_NAME: connect
      CONNECT_REST_PORT: 8083
      CONNECT_LISTENERS: "https://0.0.0.0:8083"
      CONNECT_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: "HTTPS"
      CONNECT_GROUP_ID: compose-connect-group
      CONNECT_CONFIG_STORAGE_TOPIC: docker-connect-configs
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_FLUSH_INTERVAL_MS: 10000
      CONNECT_OFFSET_STORAGE_TOPIC: docker-connect-offsets
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_TOPIC: docker-connect-status
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_KEY_CONVERTER: io.confluent.connect.avro.AvroConverter
      CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL: 'http://schemaregistry:8081'
      CONNECT_VALUE_CONVERTER: io.confluent.connect.avro.AvroConverter
      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: 'http://schemaregistry:8081'
      CONNECT_INTERNAL_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_INTERNAL_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      CONNECT_PLUGIN_PATH: "/usr/share/java,/etc/kafka-connect/custom-plugins"
      CONNECT_LOG4J_ROOT_LOGLEVEL: WARN
      CONNECT_CUB_KAFKA_TIMEOUT: 240
      CLASSPATH: /usr/share/java/monitoring-interceptors/monitoring-interceptors-5.2.0.jar
      # Connect worker
#      CONNECT_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_SASL_JAAS_CONFIG: "org.apache.kafka.common.security.scram.ScramLoginModule required username=\"client\" password=\"client-secret\";"
      CONNECT_SASL_MECHANISM: SCRAM-SHA-256
      CONNECT_SSL_TRUSTSTORE_LOCATION: /etc/kafka-connect/secrets/kafka.connect.truststore.pfx
      CONNECT_SSL_TRUSTSTORE_PASSWORD: krakenmare
      CONNECT_SSL_KEYSTORE_LOCATION: /etc/kafka-connect/secrets/kafka.connect.keystore.pfx
      CONNECT_SSL_KEYSTORE_PASSWORD: krakenmare
      # Connect producer
#      CONNECT_PRODUCER_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_PRODUCER_SASL_JAAS_CONFIG: "org.apache.kafka.common.security.scram.ScramLoginModule required  username=\"client\"  password=\"client-secret\";"
      CONNECT_PRODUCER_SASL_MECHANISM: SCRAM-SHA-256
      CONNECT_PRODUCER_SSL_TRUSTSTORE_LOCATION: /etc/kafka-connect/secrets/kafka.connect.truststore.pfx
      CONNECT_PRODUCER_SSL_TRUSTSTORE_PASSWORD: krakenmare
      CONNECT_PRODUCER_SSL_KEYSTORE_LOCATION: /etc/kafka-connect/secrets/kafka.connect.keystore.pfx
      CONNECT_PRODUCER_SSL_KEYSTORE_PASSWORD: krakenmare
      CONNECT_PRODUCER_SSL_KEY_PASSWORD: krakenmare
      # Connect consumer
#      CONNECT_CONSUMER_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_CONSUMER_SASL_JAAS_CONFIG: "org.apache.kafka.common.security.scram.ScramLoginModule required username=\"client\" password=\"client-secret\";"
      CONNECT_CONSUMER_SASL_MECHANISM: SCRAM-SHA-256
      CONNECT_CONSUMER_SSL_TRUSTSTORE_LOCATION: /etc/kafka-connect/secrets/kafka.connect.truststore.pfx
      CONNECT_CONSUMER_SSL_TRUSTSTORE_PASSWORD: krakenmare
      CONNECT_CONSUMER_SSL_KEYSTORE_LOCATION: /etc/kafka-connect/secrets/kafka.connect.keystore.pfx
      CONNECT_CONSUMER_SSL_KEYSTORE_PASSWORD: krakenmare
      CONNECT_CONSUMER_SSL_KEY_PASSWORD: krakenmare
      # Required for Schema Registry HTTPS
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka-connect/secrets/broker_jaas.conf -Djavax.net.ssl.trustStore=/etc/kafka-connect/secrets/kafka.connect.truststore.pfx -Djavax.net.ssl.trustStorePassword=krakenmare -Djavax.net.ssl.keyStore=/etc/kafka-connect/secrets/kafka.connect.keystore.pfx -Djavax.net.ssl.keyStorePassword=krakenmare"
      SCHEMA_REGISTRY_OPTS: "-Djavax.net.ssl.trustStore=/etc/kafka-connect/secrets/kafka.client.truststore.pfx -Djavax.net.ssl.trustStorePassword=krakenmare -Djavax.net.ssl.keyStore=/etc/kafka-connect/secrets/kafka.client.keystore.pfx -Djavax.net.ssl.keyStorePassword=krakenmare"
      # We create topics in connector so we need Zookeeper and Kafka options
      KAFKA_SASL_JAAS_CONFIG: "org.apache.kafka.common.security.scram.ScramLoginModule required username=\"client\" password=\"client-secret\";"
      KAFKA_SASL_MECHANISM: SCRAM-SHA-256
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka-connect/secrets/kafka.client.truststore.pfx
      KAFKA_SSL_TRUSTSTORE_PASSWORD: krakenmare
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka-connect/secrets/kafka.client.keystore.pfx
      KAFKA_SSL_KEYSTORE_PASSWORD: krakenmare
      KAFKA_ZOOKEEPER_SET_ACL: "true"
    secrets:
      - broker_jaas.conf
      - client-sasl_ssl.conf
      - kafka.connect.truststore.jks
      - kafka.connect.keystore.jks
      - kafka.client.truststore.jks
      - kafka.client.keystore.jks
      - connect.certificate.pem
      - connect.key
      - bd-ca-1.crt
    <<: *deploy
    networks:
      - zookeeper_kafka
      - krakenmare

  framework:
    image: ${REGISTRY_FULL_PATH}framework
    build:
      context: framework
      dockerfile: Dockerfile
    hostname: framework
    ports: 
      - "8080:8080"
      - "31760:31757"
    environment:
      REDIS_SERVER: "redis:6379"
      BOOTSTRAP_SERVERS: "broker-1:9092,broker-2:9093,broker-3:9094"
    <<: *deploy
    networks:
      - krakenmare

  redis:
    image: redis:5.0.3
    hostname: redis
    ports:
      - "6379:6379"
    <<: *deploy
    networks:
      - krakenmare

# No hostname is asserted. We want the docker host's name for this container
  collectd:
    image: ${REGISTRY_FULL_PATH}collectd
    build:
      context: collectd
      dockerfile: Dockerfile
    deploy:
      restart_policy:
        condition: none
      placement:
        constraints:
          - node.labels.injectors == true
    networks:
      - krakenmare

  influxdb:
    # image: influxdb:latest
    image : influxdb:1.7.6
    hostname: influxdb
    ports:
      - "8086:8086"
    environment:
# https://docs.docker.com/samples/library/influxdb/
      INFLUXDB_DB: datapipes
    <<: *deploy
    networks:
      - krakenmare

  datapipes-monitor:
    image: ${REGISTRY_FULL_PATH}datapipes-monitor
    build:
      context: datapipes-monitor
      dockerfile: Dockerfile
    hostname: datapipesmonitor
    ports:
      - "7575:7575"
    <<: *deploy
    networks:
      - krakenmare

  prometheus:
    image: prom/prometheus
    hostname: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    <<: *deploy
    networks:
      - krakenmare

  config-zookeeper:
    image: ${REGISTRY_FULL_PATH}config-zookeeper
    build:
      context: config-zookeeper
      dockerfile: Dockerfile
    hostname: config-zk
    <<: *deploy
    secrets:
      - zookeeper_jaas.conf
      - broker_jaas.conf
    networks:
      - zookeeper_kafka
      - krakenmare

  config-schemaregistry:
    image: ${REGISTRY_FULL_PATH}config-schemaregistry
    build:
      context: config-schemaregistry
      dockerfile: Dockerfile
    hostname: config-schemaregistry
    <<: *deploy
    secrets:
      - schemaregistry.certificate.pem
      - schemaregistry.key
      - km-ca-1.crt
    networks:
      - zookeeper_kafka
      - krakenmare

networks:
# zookeeper_kafka is zookeeper and kafka components (brokers, connect, schema registry) plus druid (needs zk)
# it is not attachable to prevent other containers from connecting
# it is encrypted because zk does not support TLS natively
  zookeeper_kafka:
    driver: overlay
    attachable: false
    driver_opts:
      encrypted: "true"
# krakenmare is the general network for all containers
# it is attachable to allow other containers to connect
# it is not encrypted because we are doing that at the application layer
  krakenmare:
    driver: overlay
    attachable: true
    driver_opts:
      encrypted: "false"
      