---
- name: Ansible setup for the scalability analysis
  hosts: localhost

# Edit variables.
  vars:
    RHEL_Version: rh8rc4_x86_64
    iso_server: 16.16.184.151
    #generated with : 
    #password is bdu
    # ansible all -i localhost, -m debug -a "msg={{ 'bdu' | password_hash('sha512', 'SALT') }}"
    password: $6$SALT$Wa/AELdu4Dldnl.NGK5MNMQNobyfR.tqJhy91aRf5xjVt5zD.sTmZJuevosCb7g4cMoJ3wdRReoAB2fakVJgP/


# End of variables

########################################
#NOTHING TO CHANGE UNDER THIS LINE
########################################

  tasks:

  - name: Mount repo from iso to /data/repositories
    mount:
      path: /data/repositories
      src: "{{iso_server}}:/data/repositories"
      state: mounted
      fstype: nfs


  - name: Add repository to yum (1/2)
    yum_repository:
      name: AppStream
      description: Repo AppStream from {{RHEL_Version}}
      baseurl: file:///data/repositories/{{RHEL_Version}}/AppStream
      file: dvd
      enabled: yes
      gpgcheck: no

  - name: Add repository to yum (2/2)
    yum_repository:
      name: BaseOS
      description: Repo BaseOS from {{RHEL_Version}}
      baseurl: file:///data/repositories/{{RHEL_Version}}/BaseOS
      file: dvd
      enabled: yes
      gpgcheck: no


  - name: Install yum-utils,wget,git and tmux
    yum:
      name:
        - yum-utils
        - wget
        - git
        - tmux
      state: latest


  - name: Add docker-ce repository to yum
    get_url:
      url: https://download.docker.com/linux/centos/docker-ce.repo
      dest: /etc/yum.repos.d/docker-ce.repo

  - name: Install the containerd.io-1.2.5-3.1.el7.x86_64 rpm from a remote repo
    yum:
      name: https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.5-3.1.el7.x86_64.rpm
      state: present

  - name: Install docker-ce
    yum:
      name: docker-ce
      state: latest
      disable_gpg_check: yes

  - name : Setup HPE proxy for Docker in  /etc/systemd/system/docker.service.d/http-proxy.conf
    blockinfile:
      path: /etc/systemd/system/docker.service.d/http-proxy.conf
      create: yes
      block: |
        [Service]
        Environment="HTTP_PROXY=http://web-proxy.corp.hpecorp.net:8080" "HTTPS_PROXY=http://web-proxy.corp.hpecorp.net:8080" 
  

  - name : Setup HPE proxy for Docker in  /etc/docker/daemon.json
    copy:
      dest: /etc/docker/daemon.json
      backup: yes
      content: |
        {
          "insecure-registries" : ["o184i024.gre.smktg.hpecorp.net:4567"],
          "dns" : ["16.110.135.51", "8.8.8.8"],
          "dns-search" : ["emea.hpqcorp.net"]
        }


  - name: Run deamon-reload then restart Docker service 
    systemd:
      state: restarted
      daemon_reload: yes
      name: docker

