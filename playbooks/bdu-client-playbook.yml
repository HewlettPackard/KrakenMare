---
- name: Ansible setup for the scalability analysis
  hosts: "{{ hosts }}"

# Edit variables.
  vars:
    ansible_python_interpreter : '/usr/bin/python3'

    RHEL_Version: rh8rc4_x86_64
    iso_server: 172.16.7.253
    iso_source_path: /opt/cmu/repositories
    iso_mount_point : /opt/cmu/repositories
    docker_compose_Version : 1.24.0
    #generated with :
    #password is bdu
    # ansible all -i localhost, -m debug -a "msg={{ 'bdu' | password_hash('sha512', 'SALT') }}"
    password: $6$SALT$Wa/AELdu4Dldnl.NGK5MNMQNobyfR.tqJhy91aRf5xjVt5zD.sTmZJuevosCb7g4cMoJ3wdRReoAB2fakVJgP/
    proxy : http://web-proxy.corp.hpecorp.net:8080




  environment:
    http_proxy: "{{ proxy }}"
    https_proxy: "{{ proxy }}"


# End of variables




########################################
#NOTHING TO CHANGE UNDER THIS LINE
########################################

  tasks:
  - name: Mount repo from {{iso_server}}:{{ iso_source_path }} to {{iso_mount_point}}
    mount:
      path: "{{ iso_mount_point }}"
      src: "{{iso_server}}:{{ iso_source_path }}"
      state: mounted
      fstype: nfs


  - name: Add repository to yum (1/2)
    yum_repository:
      name: AppStream
      description: Repo AppStream from {{RHEL_Version}}
      baseurl: file://{{ iso_mount_point }}/{{RHEL_Version}}/AppStream
      file: dvd
      enabled: yes
      gpgcheck: no

  - name: Add repository to yum (2/2)
    yum_repository:
      name: BaseOS
      description: Repo BaseOS from {{RHEL_Version}}
      baseurl: file://{{ iso_mount_point }}/{{RHEL_Version}}/BaseOS
      file: dvd
      enabled: yes
      gpgcheck: no


  - name: Install yum-utils,wget,git and tmux
    yum:
      name:
        - yum-utils
        - wget
        - git
        - tmux
      state: latest


  - name: Add docker-ce repository to yum
    get_url:
      url: https://download.docker.com/linux/centos/docker-ce.repo
      dest: /etc/yum.repos.d/docker-ce.repo

  - name: Install the containerd.io-1.2.5-3.1.el7.{{ ansible_architecture }} rpm from a remote repo
    yum:
      name: https://download.docker.com/linux/centos/7/{{ ansible_architecture }}/stable/Packages/containerd.io-1.2.5-3.1.el7.{{ ansible_architecture }}.rpm
      state: present

  - name: Install docker-ce
    yum:
      name: docker-ce
      state: latest
      disable_gpg_check: yes

  - name : Setup HPE proxy for Docker Registry  in  /etc/systemd/system/docker.service.d/http-proxy.conf
    blockinfile:
      path: /etc/systemd/system/docker.service.d/http-proxy.conf
      create: yes
      block: |
        [Service]
        Environment="HTTP_PROXY={{ proxy }}" "HTTPS_PROXY={{ proxy }}"
    when: docker_mirror_registry_address is undefined or docker_mirror_registry_port is undefined

  - name : Setup HPE proxy for Docker in  /etc/systemd/system/docker.service.d/http-proxy.conf
    blockinfile:
      path: /etc/systemd/system/docker.service.d/http-proxy.conf
      create: yes
      state: absent
      block: |
        [Service]
        Environment="HTTP_PROXY={{ proxy }}" "HTTPS_PROXY={{ proxy }}"
    when: docker_mirror_registry_address is defined and docker_mirror_registry_port is defined

  - name: Create /etc/docker/ if it doesn't exist
    file:
      path: "{{ item }}"
      state: directory
      owner: root
      group: root
      mode: 0775
    with_items:
      - /etc/docker

  - name : Setup docker and use a local mirror registry
    copy:
      dest: /etc/docker/daemon.json
      backup: yes
      content: |
        {
          "insecure-registries" : ["o184i024.gre.smktg.hpecorp.net:4567","http://{{ docker_mirror_registry_address }}:{{ docker_mirror_registry_port }}"],
          "registry-mirrors": ["http://{{ docker_mirror_registry_address }}:{{ docker_mirror_registry_port }}"],
          "dns" : ["16.110.135.51", "16.110.135.52"],
          "dns-search" : ["emea.hpqcorp.net"]
        }
    when: docker_mirror_registry_address is defined and docker_mirror_registry_port is defined

  - name : Setup docker
    copy:
      dest: /etc/docker/daemon.json
      backup: yes
      content: |
        {
          "insecure-registries" : ["o184i024.gre.smktg.hpecorp.net:4567"],
          "dns" : ["16.110.135.51", "16.110.135.52"],
          "dns-search" : ["emea.hpqcorp.net"]
        }
    when: docker_mirror_registry_address is undefined or docker_mirror_registry_port is undefined


  - name: Run deamon-reload then restart Docker service
    systemd:
      state: restarted
      daemon_reload: yes
      name: docker

  - name: Add the user 'bdu'
    user:
      name: bdu
      password: "{{password}}"
      groups: docker,wheel
      append: yes

  - name: Download docker-compose
    get_url:
      url: "https://github.com/docker/compose/releases/download/{{ docker_compose_Version }}/docker-compose-{{ ansible_system }}-{{ ansible_architecture }}"
      dest: /usr/local/bin/docker-compose

  - name: Allow execution of /usr/local/bin/docker-compose
    file:
      path: /usr/local/bin/docker-compose
      mode : "u+x,o+x"
